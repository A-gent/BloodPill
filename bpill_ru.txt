Blood Pill версия 0.9
----
Комплексная утилита для Blood Omen: Legacy Of Kain, 
предназначенная для манипуляций с pill.big и внутренними файлами Blood Omen

======================================================

 ВВЕДЕНИЕ

======================================================

 Отсутствие утилиты командной строки, способной работать с pill.big сподвигло меня
на написания этой маленькой программы.

 Программа написана на языке C, исходный код распространяется под лицензией GPL

 Программа содержит как основной функционал, позволяющий проводит простые манипуляции с содержанием
pill.big (извлекать, конвертировать, просматривать), так и много дополнительных возможностей
которые могут быть полезны моддерам.

 Если вам просто нужно распаковать и посмотреть содержание pill.big, 
возпользуйтесь BAT-скриптами в папке Samples

 Важно: Программа большая, при изменениях я один не могу тестировать все возможности, 
поэтому если вы найдете баг или неработающие ключи, сообщите мне на e-mail или на форум legacy-of-kain.ru.

 В исходном коде использованы наработки:
 ----
  - Виталий [Mean Person] Гронь: описание формата Blood Omen PC Release Headerless VAG
  - Forest [LordHavoc] Hale : утилитарные функции
  - Balder и Zench с форумов XentaX (www.xentax.com): спецификации pill.big и помощь советами
  - Klarth (stevemonaco@hotmail.com) и 
    Raul Sobon (Cheekyboy@2-hot.com): спецификации TIM
  - Андрей [Rackot] Грачев: спецификации Bigfile
  - Ben Lincoln: спецификации Raw Type 7 (тайлы)

 приятного чтения
 Павел [VorteX] Тимофеев
 paul.vortex@gmail.com

======================================================

 КАК ИСПОЛЬЗОВАТЬ

======================================================

 в квадратных скобках представлены не обязательные к использованию аргументы
 
 bpill.exe [-w] [-mem] [-nc] [-soxpath "путь"] стадия
  -w : ждать нажатия клавиши до завершения работы
  -mem : статистика об использовании памяти
  -nc : не печатать заголовок (удобно если программа запускается 
циклом)
  -c : не печатать заголовок и доп. сообщения
  -f : не печатать ничего кроме ошибок
  -cd : установить текущую папку
  -ew : ждать нажатия клавиши если случилась ошибка
  -soxpath "путь": свой путь к программе SoX

======================================================

 СТАДИИ

======================================================

--------
Получение статистических сведений о pill.big:
--------

 -bigfile [файл.big] [-klist файл] -list [файл] [дополнительные_опции]
 
 ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ:
   -сsv файл: создать csv-листфайл для утилиты Wheel Of Doom

--------
Распаковка .big файла:
--------

 -bigfile [файл.big] [-klist файл] -unpack [папка] [дополнительные_опции]
 
 ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ:
   -tim2tga: автоконвертирования TIM в TGA
   -16to24: при конвертировании в TGA, преобразовывать 16-бит цветность в 24-бит
   -adpcm2wav: автоматическая конвертация ADPCM-файлов в WAVE, с сохранением нативного кодирования 4-bit ADPCM
   -adpcm2pcm: автоматическая конвертация ADPCM-файлов в WAVE 16-bit PCM
   -adpcm2ogg: автоматическая конвертация ADPCM-файлов в Ogg 
   -vag2wav: автоматическая конвертация VAG-файлов в WAVE
   -vag2ogg: автоматическая конвертация VAG-файлов в Ogg 
Vorbis (Quality 5)
   -raw2tga: конвертирует все опознанные RAW картинки в TGA. ВНИМАНИЕ: создает ОЧЕНЬ много файлов (около 35000).
   -rawnoalign: отключает автовыравнивание ширины/высоты для всех RAW ффйлов. Файлы получаются меньше, но и работать с ними труднее.

--------
Запаковка .big файла:
--------

Для нёё требуется listfile.txt и папка с исходными файлами, все это можно
получить операцией распаковки.

 -bigfile [файл.big] -pack [папка]

--------
Распаковка определенного файла из .big
--------

 Для того чтобы распаковать определенный файл, необходимо возпользоваться следующей строкой:

 -bigfile [файл.big] -extract имя_сущности выходной.файл [-f формат] [дополнительные_опции]
    
    имя_сущности : #хеш имя или полноценное дехешированное имя
    
    выходной.файл : файл которых хочется получить на выходе 
                    (можно без расширения если тип заранее не известен)
   
    формат : формат файла, один из следующих:
           wav   - WAVE files (для ADPCM/VAG)
           ogg   - файлы Ogg Vorbis files (для ADPCM/VAG/WAV)
           tga   - Targa (для спрайтов и TIM)
           tga24 - Targa 24 битная
           spr32 - Darkplaces SPR32 (только для спрайтов)

    Важно: если фотмат не указан, он подхватывается из расширения выходного файла

ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ ДЛЯ ЗВУКОВ:
    
  -ir X        : частота звука (влияет на скорость воспроизведения), для некоторых файлов её надо устанавливать вручную
  -trimstart X : срезать X секунд с начала 
  -speed X     : изменить скорость файла (аналогично -ir), X - множитель (1 - нет изменений)
  -tempo X R   : изменить продолжительность звука без изменения тональности
                 X - множитель, R - интервал поиска, типичное значение 0.9 40
  -pitch X R   : изменить тональность звука
  -gain X      : добавить или убавить громкость
  -bass X      : добавить или убавить громкость для низких частот
  -treble X    : добавить или убавить громкость для высоких частот
  -normalize   : нормализация громкости
  -reverb      : включить эффект ревербации

ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ ДЛЯ СПРАЙТОВ:

   -i x-y : распаковывать только эти кадры, например -i 1-2, опция может быть использована несколько раз
   -replacecolormap файл.tga : заменить палитру на оную из подставленного файла
   -ofs x y : сдвинуть центр спрайта (только для spr32)
   -nearest2x : увеличить картинки в 2 раза с применением nearest-фильтрации
   -flip : отразить картинки слева направо
   -nocrop : не обрезать картинку по пустым пикселям (только для spr32)
   -noalign : не подстраивать все кадры под единый размер (удобно для spr32)
   -alpha X : установить прозрачность картинки (только для spr32)
   -shadowalpha X : установить прозрачность теней (только для spr32)
   -shadowcolor XXXXXX : установить свой цвет для теней (XXXXXX - HEX представление цвета)
   -bgcolor XXXXXX : установить свой цвет для фона 
   -colormapscale X : изменить яркость палитры (1 - нет изменений), только для spr32

--------
Конвертирование TIM -> TGA
--------

 -tim2tga файл.tim [файл.tga] [дополнительные_опции]

 ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ:
  -16to24: см. -unpack

--------
Конвертирование TGA -> TIM
--------

-tga2tim tgafile [timfile] [дополнительные_опции]

 ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ:
  -bpp X: выбрать тип цветности (8 бит - палитра, 16 бит, 24 бит)
  -ofs X Y: установить смещение для картинки (есть у некоторых файлов TIM)
  -mask X: использовать свой суффикс маски (по умолчанию _mask)

--------
Конвертирование IMA ADPCM -> WAV
--------

-adpcmconvert vagfile outfile [дополнительные_опции]

 ДОПОЛНИТЕЛЬНЫЕ ОПЦИИ:
  -rate X: частота проигрывания VAG, по умолчанию 22050
  -pcm: при сохранении WAV конвертирует звук в формат 16-bit PCM
  -oggvorbis: конвертирует в формат Ogg Vorbis (качество 7)
  -custom "строка": свои параметры выходного файла для SoX (см. его документацию)

--------
Декодирование RAW картинок
--------

-raw infile outfile [опции]

Типы RAW:
 type0: специальный тип для отладки и массажа данных, все параметры картинки задаются ищначально
 type1: предметы/артефакты
 type2: мультиобъектный файл с палитрой на каждый объект
 type3: мультиобъектный файл с общей палитрой, обычно это параллельные спрайты
 type4: мультиобъектный файл с общей палитрой, версия 2, обычно это ориентированные спрайты (монстры, каин)
 type5: мультиобъектный файл с общей палитрой, версия 3, несколько различных спрайтов
 type6: не используется
 type7: тайлы (полностью пока не поддерживаются)

ОСНОВНЫЕ ОПЦИИ:
			 
 -type [тип]: установить тип по которому файл декодируется (см. типы RAW Файлов)
 -forcetype [тип]: тоже самое, что и type, только с менее жесткими проверками
 -noswap: при записи TGA, не переводить цветовой пространство из RGB в BGR (подразумевается что картинка уже BGR)
 -noclut: вместо палитры использовать чено-серо-белую болванку (т.е. показывать сами индексы)

ОПЦИИ ДЛЯ ТИПА 0:
 -width: ширина
 -height: высота
 -offset: позиция внутри файла
 -colormapoffset: позиция палитры внутри файла
 -colormapbytes: байт на цвет в палитре (2 или 3)
 -cmprX Y: включает RLE компрессию на определенном индексе, 
           такая компрессия используется в спрайтах, X - номер слота (1, 2, 3, 4), 
           Y - номер индекса (0-255) 

ДРУГИЕ ОПЦИИ:
 -chunk X: для мультиобъектных файлов, распаковать только чанк №X
 -doubleres: для типа 2, умножает ширину и высоту при распаковке на 2
 -noalign: отключает автовыравнивание ширины/высоты для всех RAW файлов. Файлы получаются меньше, но и работать с ними труднее.

======================================================

 ИСТОРИЯ ВЕРСИЙ

======================================================

==================
=== ВЕРСИЯ 0.9 ===
==================

НОВЫЕ ВОЗМОЖНОСТИ:  
	- ключ -sp : печатать процентный счетчик новыми линиями (опция для инсталлятора)
	- новый ключ -bigfile -patch <файл> -outfile <новый_pill.big>
	   формат патч файла:
	  RAW/DEL/WAV2ADPCM <имя_файла_или_хеш> <путь к файлу>
	   или
	  <путь к файлу> где по умолчанию действие RAW
	  а хеш вычисляется по имена #хеш или имя внутри pill.big

БАГФИКС: 
	- исправлен баг с неправильным вычислением имени по хешу для некоторых файлов, что приводило к наложению 640x480 .htm картинок на 320x240 tim
	- исправлены несколько редких багов с выведением неправильного расширения для raw файлы

==================
=== ВЕРСИЯ 0.8f ===
==================

НОВЫЕ ВОЗМОЖНОСТИ:  
	- ключ -c : не печатать заголовок и доп. сообщения
	- ключ -f : не печатать ничего кроме ошибок
	- ключ -cd : установить текущую папку
	- ключ -ew : ждать нажатия клавиши если случилась ошибка

БАГФИКС: 
	- исправлены вылеты при запуске с неправильными параметрами
	- исправлена ошибка mkdir если при распаковке даны полные пути
	- исправлены коды возвратов (коды ошибки программы) в некоторых режимах на правильные

==================
=== ВЕРСИЯ 0.8e ===
==================

БАГФИКС: 
	- сборка со статическими рантаймами

==================
=== ВЕРСИЯ 0.8c ===
==================

БАГФИКС: 
	- исправлена распаковка мультичанковых файлов (vortout.all и пр.) 

	- исправлены все имена ADPCM speech-файлов, чтобы лежать в правильных папках, папка boss разбита на папки конкретных боссов - bane, mortanius и т.д.

НОВЫЕ ВОЗМОЖНОСТИ:
	- скриптовый язык для пакетной распаковки pill.big в ZIP файл, который может быть использован современными движками


==================
=== ВЕРСИЯ 0.8b ===
==================

БАГФИКС: 
	- чистка кода, значительно убыстрена стадия -pack

НОВЫЕ ВОЗМОЖНОСТИ: 
	- автоматическое обратное преобразование хеш-имен в реальные имена 
          (спасибо Ben Lincoln и Андрею [Rackot] Грачеву). 
          По умолчанию используется внутренняя таблица, но если положить 
          рядом с утилитой файл BO1.csv, то программа прочтет имена оттуда.

	- детектирование и распаковка тайлов (Raw Type 7), 
          спасибо Бену Линкольну за работы по реверс-инжинирингу компрессии.

	- полноценная распаковка pill.big из PSX-версии (но не запаковка, нет
	  конвертации WAV->VAG/FAG)

ОБНОВЛЕНИЯ:

	- для -extract добавлена обработка по имени файла 
	  (хеши теперь должны представляться с префиксом #), 

	- добавлена возможность распаковки VAG (опции те же, что и для ADPCM)

	- ключ -extract задокументирован

	- при распаковке с конверсией, оригинальные файлы кладутся в папку 
	  'original' чтобы не мешаться при просмотре

	- нулевые файлы теперь не экспортируются (не пишутся физически на диск)

	- -unpack теперь распаковывает файлы с реальными именами, 
	  чтобы вернуть старое поведение используйте ключ -hashasnames

	- доработаны семпл-скрипты

	- добавлен файл bo_filetypes.txt, содержащий грубые спецификации 
	  различных типов файлов БО для нужд модмейкеров

	- улучшена поддержка PSX-версии pill.big


==================
=== ВЕРСИЯ 0.6a ===
==================

ФИЧА: новая стадия -extract для распаковки определенного файла из pill.big

БАГФИКС: исправлены многочисленные ошибки в записи файлов когда перед записью файла с заданным путем папки для этого пути 
         не создавались автоматически (что приводило к ошибке "cannot open file for writing")

ОБНОВЛЕНИЕ: удалены опции -vagconvert, -pcm, -ogg, -rawconvert -noalign из стадии "-bigfile -unpack"
           вместо них добавлены -adpcm2wav, -adpcm2pcm, -adpcm2ogg, -raw2tga, -tawnoalign

ОБНОВЛЕНИЕ: удалена опция -dstdir из стадии "-bigfile -unpack", теперь папка задается опциональным параметром сразу после -unpack
           пример: -unpack bigfile2

ОБНОВЛЕНИЕ: удалена опция -srcdir из стадии "-bigfile -pack", теперь папка задается опциональным параметром сразу после -pack
           пример: -pack bigfile2

ОБНОВЛЕНИЕ: удалена опция -lowmem из стадии "-bigfile -pack", алгоритм низкого потребления памяти теперь всегда используется

ОБНОВЛЕНИЕ: удалена опция -to из стадии "-bigfile -list", аналогично -dstdir теперь задается сразу после -list
           пример: -list mylistfile.txt

ОБНОВЛЕНИЕ: удалена недокументированная стадия "-bigfile -analyse"

==================
=== ВЕРСИЯ 0.5 ===
==================

ФИЧА: распаковка всех спрайтов (в т.ч. каина и врагов) на кадры в формате TGA. Создается ОЧЕНЬ много файлов (около 35000).

ФИЧА: автовыравнивание ширины/высоты для всех спрайтов, упрощает просмотр и работу с ними

ФИЧА: генерация CSV файла для экспорта листинга в утилиту Wheel Of Doom или Soul Spiral

ОБНОВЛЕНИЕ: задокументирована стадия -raw (распаковка RAW картинок) и типы RAW

БАГФИКС: исправлены несколько утечек памяти

==================
=== ВЕРСИЯ 0.4 ===
==================

ФИЧА: опция -rawconvert для bigfile unpack. Распаковывает некоторые RAW картинки (иконки, предметы) в TGA

ФИЧА: различные форматы файлов имеют свою папку при экспорте, .tim кладутся в tim/, .dat в unknown

ОБНОВЛЕНИЕ: улучшена поддержка различных версий pill.big за счет усиления связки "автосканнер формата"->"список известных"

ОБНОВЛЕНИЕ: исправлен баг с иногда не работающим репаком pill.big (ошибка wrong file type)

==================
=== ВЕРСИЯ 0.3 ===
==================

ФИЧА: С помощью Mean Person удалось узнать принцип проигрывания VAG
 добавлена -vagconvert стадия и одноименный ключик для стадии -unpack, 
 автоматически конвертирует VAG а WAV или Ogg Vorbis, конверсию обеспечивает внешняя программа SoX
 Внимание: конвертирование в формат, отличный от дефолтового ADPCM может привести к потерям в звуке при повторной
           запаковке pill.big, так как будет производится обратное конвертирование.

ОБНОВЛЕНИЕ: -pack поддерживает автоконвертирование из WAV/OGG обратно в VAG

ОБНОВЛЕНИЕ: новый формат klist.txt - с более простым синтаксисом и новой опцией path, которая устанавливает
 имя выходного файла. С помощью path вместо хеш-имен для файлов можно использовать понятные имена, например music/track01.wav
 
КЛЮЧ: -soxpath "путь" - установить свой путь в программе SoX, по умолчанию программа сканирует папку с собой, 
 и подпапку SoX

БАГФИКС: программа распознавала нулевые файлы как TIM, если сразу после нулевого файла шел заголовок TIM

БАГФИКС: исправлен баг с неправильным конвертированием слоев у TIM из германской версии Blood Omen

БАГФИКС: исправлен случайный segfail при запаковке pill.big

==================
=== ВЕРСИЯ 0.2 ===
==================

ФИЧА: -tim2tga файл [-16to24] для конвертирования TIM-картинки в набор TGA файлов
 -16to24 - конвертирование 16-битной картинки в 24 битную

ФИЧА: -tga2tim файл [-bpp x] [-ofs XY] [-mask X] для конвертирования TGA файлов
 предупреждение: не обрабатывает мультислойные TIM (их в pill.big всего 2 или 3 штуки)
 -bpp - выбрать тип цветности (8 бит - палитра, 16 бит, 24 бит)
 -ofs - установить смещение для картинки (есть у некоторых файлов TIM)
 -mask - использовать 

КЛЮЧ: -tim2tga для -pillbig -unpack, распаковывает все TIM-картинки
 также прописывает в listfile.txt все необходимые параметры для последующей
 обратной запаковки (с помощью стадии -pack)

КЛЮЧ: -nc ПЕРЕД стадией (-bigfile, -tim2tga и пр.) для отмены печати заголовка программы

КЛЮЧ: -lowmem для стадии -pack, уменьшает требования к памяти за счет небольшого падения скорости

ФИЧА: автоопределение RIFF WAVE звуков при распаковке pill.big

ОБНОВЛЕНИЕ: список известный файлов теперь включает все диалоги 

ОБНОВЛЕНИЕ: расширение VAG изменено на RAW-ADPCM

==================
=== ВЕРСИЯ 0.1 ===
==================

ФИЧА: вывод информации о всех файлах в pill.big
 bpill -bigfile [имябигфайла] -list [-to имяфайла]
 если [имябигфайла] не указано, то будет использоваться pill.big
 -to имяфайла - выводит список во внешний текстовый файл
 
ФИЧА: распаковка pill.big (распаковываются все файлы и лист-файл)
 bpill -bigfile [имябигфайла] -unpack [-dstdir имяпапки]
 -dstdir устанавливает папку назначения (по умолчанию bigfile)

ФИЧА: запаковка pill.big на базе набора файлов и лист-файла
 bpill -bigfile [имябигфайла] -pack [-srcdir имяпапки]
 -dstdir устанавливает исходную папку (по умолчанию bigfile)

ФИЧА: -bigfile: список известный файлов
 нужна чтобы определять RAW ADPCM файлы (голос персонажей, музыка)
 действует вместе с -list и -unpack
 чтобы активировать, в конце командной строки добавить:
 -klist klist.txt
 в архив с утилитой включен список известных VAG файлов klist.txt

ПАРАМЕТР: -w перед стадией ()
 
