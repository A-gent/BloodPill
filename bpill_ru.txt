Blood Pill версия 0.3rc1
----
Комплексная утилита для Blood Omen: Legacy Of Kain, 
предназначенная для манипуляций с pill.big и внутренними файлами Blood Omen

======================================================
 ВВЕДЕНИЕ
======================================================

 Отсутствие утилиты командной строки, способной работать с pill.big сподвигло меня
на написания этой маленькой программы.

 Программа написана на языке C, исходный код распространяется под лицензией GPL

 В исходном коде использованы наработки:
 ----
  - Виталий [Mean Person] Гронь: описание формата Blood Omen PC Release .VAG
  - Forest [LordHavoc] Hale : утилитарные функции
  - Balder и Zench с форумов XentaX (www.xentax.com): спецификации pill.big и помощь советами
  - Klarth (stevemonaco@hotmail.com) и 
    Raul Sobon (Cheekyboy@2-hot.com): спецификации TIM
  - Андрей [Rackot] Грачев: спецификации Bigfile

 приятного чтения
 Павел [VorteX] Тимофеев
 paul.vortex@gmail.com

======================================================
 КАК ИСПОЛЬЗОВАТЬ
======================================================

 в квадратных скобках представлены не обязательные к использованию аргументы
 
 bpill.exe [-w] [-mem] [-nc] [-soxpath "путь"] стадия
  -w : ждать нажатия клавиши до завершения работы
  -mem : статистика об использовании памяти
  -nc : не печатать заголовок (удобно если программа запускается циклом)
  -soxpath "путь": свой путь к программе SoX

======================================================
 СТАДИИ
======================================================

--------
Получение статистических сведений о pill.big:
--------

 -bigfile [файл.big] -list [-to файл] [-klist файл]
   -to: вывод в отдельный файл\n"
   -klist: использовать свой known-list(по умолчанию klist.txt)
   -сsv файл: создать csv-листфайл для утилиты Wheel Of Doom

--------
Распаковка .big файла:
--------

 -bigfile [файл.big] -unpack [-dstdir папка] [-klist файл] [-tim2tga] [-16to24] [-vagconvert] [-pcm]/[-oggvorbis]
   -dstdir: своя папка назначение (по умолчанию bigfile)
   -tim2tga: автоконвертирования TIM в TGA
   -16to24: при конвертировании в TGA, преобразовывать 16-бит цветность в 24-бит
   -vagconvert: автоматическая конвертация VAG->WAV, по умолчанию используется нативный формат 4-bit ADPCM
   -pcm: вместе с -vagconvert, при сохранении WAV конвертирует звук в формат 16-bit PCM
   -oggvorbis: вместе с -vagconvert, конвертирует весь звук в формат Ogg Vorbis (качество 7)
   -scanraw: проводит глубокое сканирование RAW форматов
   -rawconvert: конвертирует все опознанные RAW картинки в TGA. ВНИМАНИЕ: создает ОЧЕНЬ много файлов (около 35000).
   -noalign: отключает автовыравнивание ширины/высоты для всех RAW ффйлов. Файлы получаются меньше, но и работать с ними труднее.

--------
Запаковка .big файла:
--------

Для нёё требуется listfile.txt и папка с исходными файлами, все это можно
получить операцией распаковки.

 -bigfile [файл.big] -pack [-srcdir папка] [-lowmem]
   -srcdir: своя исходная папка (по умолчанию 'bigfile')
   -lowmem: малой использование памяти за счет падения скорости обработки

--------
Конвертирование TIM -> TGA
--------

 -tim2tga файл.tim [файл.tga] [-16to24]
  -16to24: см. -unpack

--------
Конвертирование TGA -> TIM
--------

-tga2tim tgafile [timfile] [-bpp X] [-ofs X Y] [-mask X]
  -bpp: выбрать тип цветности (8 бит - палитра, 16 бит, 24 бит)
  -ofs: установить смещение для картинки (есть у некоторых файлов TIM)
  -mask: использовать свой файл маски (по умолчанию %имяфайла%_mask.%расширение_файла%)

--------
Конвертирование VAG -> WAV
--------

-vagconvert vagfile outfile [-rate X] [-pcm]/[-oggvorbis]/[-custom "команды"]
  -rate: частота проигрывания VAG, по умолчанию 22050
  -pcm: при сохранении WAV конвертирует звук в формат 16-bit PCM
  -oggvorbis: конвертирует в формат Ogg Vorbis (качество 7)
  -custom: свои параметры выходного файла для SoX (см. его документацию)

--------
Декодирование RAW картинок
--------

-raw infile outfile [опции]

Типы RAW:
 type0: специальный тип для отладки и массажа данных, все параметры картинки задаются ищначально
 type1: предметы/артефакты
 type2: мультиобъектный файл с палитрой на каждый объект
 type3: мультиобъектный файл с общей палитрой, обычно это параллельные спрайты
 type4: мультиобъектный файл с общей палитрой, версия 2, обычно это ориентированные спрайты (монстры, каин)
 type5: мультиобъектный файл с общей палитрой, версия 3, несколько различных спрайтов
 type6: гибридный тип между 4 и 5, по большей части ориентированные спрайты
 type7: тайлы (полностью пока не поддерживаются)
 
Основные опции:

 -type [тип]: установить тип по которому файл декодируется (см. типы RAW Файлов)
 -forcetype [тип]: тоже самое, что и type, только с менее жесткими проверками
 -noswap: при записи TGA, не переводить цветовой пространство из RGB в BGR (подразумевается что картинка уже BGR)
 -noclut: вместо палитры использовать чено-серо-белую болванку (т.е. показывать сами индексы)

Опции для Типа 0:
 -width: ширина
 -height: высота
 -offset: позиция внутри файла
 -bytes: сколько байт на цвет (от 1 до 3)
 -colormapoffset: позиция палитры внутри файла
 -colormapbytes: байт на цвет в палитре (2 или 3)
 -cmprX Y: включает RLE компрессию на определенном индексе, 
           такая компрессия используется в спрайтах, X - номер слота (1, 2, 3, 4), 
           Y - номер индекса (0-255) 

Другие опции:
 -chunk X: для мультиобъектных файлов, распаковать только чанк №X
 -doubleres: для типа 2, умножает ширину и высоту при распаковке на 2
 -noalign: отключает автовыравнивание ширины/высоты для всех RAW файлов. Файлы получаются меньше, но и работать с ними труднее.

======================================================
 ИСТОРИЯ ВЕРСИЙ
======================================================

==================
=== ВЕРСИЯ 0.5 ===
==================

ФИЧА: распаковка всех спрайтов (в т.ч. каина и врагов) на кадры в формате TGA. Создается ОЧЕНЬ много файлов (около 35000).

ФИЧА: автовыравнивание ширины/высоты для всех спрайтов, упрощает просмотр и работу с ними

ФИЧА: генерация CSV файла для экспорта листинга в утилиту Wheel Of Doom или Soul Spiral

ОБНОВЛЕНИЕ: задокументирована стадия -raw (распаковка RAW картинок) и типы RAW

БАГФИКС: исправлены несколько утечек памяти

==================
=== ВЕРСИЯ 0.4 ===
==================

ФИЧА: опция -rawconvert для bigfile unpack. Распаковывает некоторые RAW картинки (иконки, предметы) в TGA

ФИЧА: различные форматы файлов имеют свою папку при экспорте, .tim кладутся в tim/, .dat в unknown

ОБНОВЛЕНИЕ: улучшена поддержка различных версий pill.big за счет усиления связки "автосканнер формата"->"список известных"

ОБНОВЛЕНИЕ: исправлен баг с иногда не работающим репаком pill.big (ошибка wrong file type)

==================
=== ВЕРСИЯ 0.3 ===
==================

ФИЧА: С помощью Mean Person удалось узнать принцип проигрывания VAG
 добавлена -vagconvert стадия и одноименный ключик для стадии -unpack, 
 автоматически конвертирует VAG а WAV или Ogg Vorbis, конверсию обеспечивает внешняя программа SoX
 Внимание: конвертирование в формат, отличный от дефолтового ADPCM может привести к потерям в звуке при повторной
           запаковке pill.big, так как будет производится обратное конвертирование.

ОБНОВЛЕНИЕ: -pack поддерживает автоконвертирование из WAV/OGG обратно в VAG

ОБНОВЛЕНИЕ: новый формат klist.txt - с более простым синтаксисом и новой опцией path, которая устанавливает
 имя выходного файла. С помощью path вместо хеш-имен для файлов можно использовать понятные имена, например music/track01.wav
 
КЛЮЧ: -soxpath "путь" - установить свой путь в программе SoX, по умолчанию программа сканирует папку с собой, 
 и подпапку SoX

БАГФИКС: программа распознавала нулевые файлы как TIM, если сразу после нулевого файла шел заголовок TIM

БАГФИКС: исправлен баг с неправильным конвертированием слоев у TIM из германской версии Blood Omen

БАГФИКС: исправлен случайный segfail при запаковке pill.big

==================
=== ВЕРСИЯ 0.2 ===
==================

ФИЧА: -tim2tga файл [-16to24] для конвертирования TIM-картинки в набор TGA файлов
 -16to24 - конвертирование 16-битной картинки в 24 битную

ФИЧА: -tga2tim файл [-bpp x] [-ofs XY] [-mask X] для конвертирования TGA файлов
 предупреждение: не обрабатывает мультислойные TIM (их в pill.big всего 2 или 3 штуки)
 -bpp - выбрать тип цветности (8 бит - палитра, 16 бит, 24 бит)
 -ofs - установить смещение для картинки (есть у некоторых файлов TIM)
 -mask - использовать 

КЛЮЧ: -tim2tga для -pillbig -unpack, распаковывает все TIM-картинки
 также прописывает в listfile.txt все необходимые параметры для последующей
 обратной запаковки (с помощью стадии -pack)

КЛЮЧ: -nc ПЕРЕД стадией (-bigfile, -tim2tga и пр.) для отмены печати заголовка программы

КЛЮЧ: -lowmem для стадии -pack, уменьшает требования к памяти за счет небольшого падения скорости

ФИЧА: автоопределение RIFF WAVE звуков при распаковке pill.big

ОБНОВЛЕНИЕ: список известный файлов теперь включает все диалоги 

ОБНОВЛЕНИЕ: расширение VAG изменено на RAW-ADPCM

==================
=== ВЕРСИЯ 0.1 ===
==================

ФИЧА: вывод информации о всех файлах в pill.big
 bpill -bigfile [имябигфайла] -list [-to имяфайла]
 если [имябигфайла] не указано, то будет использоваться pill.big
 -to имяфайла - выводит список во внешний текстовый файл
 
ФИЧА: распаковка pill.big (распаковываются все файлы и лист-файл)
 bpill -bigfile [имябигфайла] -unpack [-dstdir имяпапки]
 -dstdir устанавливает папку назначения (по умолчанию bigfile)

ФИЧА: запаковка pill.big на базе набора файлов и лист-файла
 bpill -bigfile [имябигфайла] -pack [-srcdir имяпапки]
 -dstdir устанавливает исходную папку (по умолчанию bigfile)

ФИЧА: -bigfile: список известный файлов
 нужна чтобы определять RAW ADPCM файлы (голос персонажей, музыка)
 действует вместе с -list и -unpack
 чтобы активировать, в конце командной строки добавить:
 -klist klist.txt
 в архив с утилитой включен список известных VAG файлов klist.txt

ПАРАМЕТР: -w перед стадией ()
 
